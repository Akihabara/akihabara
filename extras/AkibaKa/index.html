<html>
	<head>
		<!-- Load up the templates. Each template set different parameters for each game or game section -->
		<script type="text/javascript" src="templates.js"></script>
		<!-- Load up editor plugns for the extra section -->
		<script>var extras=[]</script>
		<script type="text/javascript" src="extras/gridgenerator.js"></script>
		
		<style>
			BODY * {
				font-size:14px;font-family:verdana;
			}
			BODY A {
				color:white;
			}
			#menu A {
				color:black;
			}
		</style>
	</head>
	<body onload="onl()" margin=0 topmargin=0 bottommargin=0 leftmargin=0 rightmargin=0>
		<div style="position:absolute;left:0px;top:0px;width:260px;height:100%;background-color:black">
		</div>
		<div style="position:absolute;left:0px;top:0px;height:30px;width:100%;background-color:#cecece">
		</div>
		<div style="position:absolute;left:0px;top:30px;height:20px;width:100%;background-color:black">
		</div>
		<div style="position:absolute;left:10px;top:55px;width:240px;color:white" id="toolbox">
		</div>
		<div style="position:absolute;left:10px;top:5px;color:black" id="menu">
		</div>
		<div style="position:absolute;left:260px;top:32px;color:white;font-size:10px" id="status">
		</div>
		<div style="position:absolute;left:260px;top:50px;color:white;z-index:10000;background-color:black;display:none;border:10px solid black;width:700" id="detail">
		</div>
	</body>
	<script>

	// Fake akihabara calls - Useful for help reading hand crafted resource files.
	var help={	
		finalizeTilemap:function(a){return a}
	}
		
		var extrasindex={};
		
		var data={
			currentopt:null,
			selectedtemplate:null,
			version:"0.1",
			editortopmargin:50,
			editorleftmargin:260,
			mo:null,
			oo:null		
		};
		
		function resetconfig() {
			// Initialize
			var empty={
				width:10,
				height:10,
				selectedlayer:0,
				penstatus:null,
				penmode:0,
				selectedsingleobject:null,
				selectedobject:(data.selectedtemplate?templates[data.selectedtemplate]._defaultobject:null),
				selectedobjectgroup:null,
				layertool:[],
				index:{}
			};
			for (var a in empty)
				data[a]=empty[a];
			// Reset data
			data.data={
				objects:{
				},
				layers:[
				],
				metadata:{
				}
			};
			data.index={images:{},tiles:{}};
		}
		
		function makeid(x,y,layer) {
			return "cel-"+x+"-"+y+"-"+layer;
		}
		
		function getid(id) {
			var spl=id.split("-");
			return {x:spl[1]*1,y:spl[2]*1,layer:spl[3]*1};
		}
		
		function getBgPosition(t,l) {
			return "-"+(data.index.tiles[data.data.layers[l].tileset].gapx+((t%data.index.tiles[data.data.layers[l].tileset].tilerow)*templates[data.selectedtemplate].tilewidth))+"px -"+(data.index.tiles[data.data.layers[l].tileset].gapy+(Math.floor(t/data.index.tiles[data.data.layers[l].tileset].tilerow)*templates[data.selectedtemplate].tilewidth))+"px"		
		}
		
		function setstatus(t) {
			document.getElementById("status").innerHTML=t;
		}
		
		function makemenu(list) {
			var ret="";
			for (var i=0;i<list.length;i++) {
				ret+="<a href=\"#\" onclick=\"opt('"+list[i].id+"')\">"+list[i].lbl+"</a>&nbsp;&nbsp;";
			}
			return ret;		
		}
		
		function deleteObjectAtIndex(x,g) {
			for (var i=x;i<data.data.objects[g].items.length-1;i++)
				data.data.objects[g].items[i]=data.data.objects[g].items[i+1];
			data.data.objects[g].items.pop();
		}
		
		function makebar(list) {
			var ret="";
			for (var i=0;i<list.length;i++) {
				if (!list[i].id) ret+="<br>"; else
				ret+="<a href=\"#\" onclick=\"tool('"+list[i].id+"')\">"+list[i].lbl+"</a><br>";
			}
			return ret;
		}
		
		function makelayer(name) {
			var ret={
				name:name,
				tileset:templates[data.selectedtemplate].addTiles[0].id,
				map:[]
			}
			if (templates[data.selectedtemplate].layermetadata)
				for (var i=0;i<templates[data.selectedtemplate].layermetadata.length;i++) ret[templates[data.selectedtemplate].layermetadata[i].id]=templates[data.selectedtemplate].layermetadata[i].defaultvalue;
			return ret;
		}
		
		function makelayertool() {
			return {
				layerhidden:false,
				selectedtile:null
			}
		}
		
		function makegroup() {
			var ret={items:[]};
			if (templates[data.selectedtemplate].objectgroupmetadata)
				for (var i=0;i<templates[data.selectedtemplate].objectgroupmetadata.length;i++) ret[templates[data.selectedtemplate].objectgroupmetadata[i].id]=templates[data.selectedtemplate].objectgroupmetadata[i].defaultvalue;
			return ret;
		}
		
		function detailshow(t) {
			document.getElementById("detail").innerHTML=t;
			document.getElementById("detail").style.display="block";
		}
		
		function detailhide() {
			document.getElementById("detail").style.display="none";		
		}
		
		function getcombovalue(id) {
			var obj=document.getElementById(id);
			return obj.options[obj.selectedIndex].value;
		}

		function makemetadatasummary(metamodel,values) {
			var ret="<span style='font-size:10px'>";
			for (var i=0;i<metamodel.length;i++) {
				value=values[metamodel[i].id];
				ret+=metamodel[i].label+": <b style='font-size:10px'>";
				switch (metamodel[i].type) {
					case "constant":
					case "text": {
						ret+=(value?value:"n/a");
						break;
					}
					case "combo": {
						var found=false;
						for (var x=0;x<metamodel[i].items.length;x++)
							if (metamodel[i].items[x].id==value) {
								ret+=metamodel[i].items[x].id+" ("+metamodel[i].items[x].label+")";
								found=true;
							}
						if (!found) ret+="n/a";
						break;
					}
				}
				ret+="</b><br>";
			}
			return ret+"</span>";
		}
		
		function makemetadataform(metamodel,values,ignore) {
			var ret="";
			var value;
			var show;
			for (var i=0;i<metamodel.length;i++) {
				value=values[metamodel[i].id];
				ret+=metamodel[i].label+"<br>";
			
				switch (metamodel[i].type) {
					case "constant": {
						var pvalue=(value?value:"");
						ret+="<input type='hidden' style='width:100%' id='attr-"+metamodel[i].id+"' value=\""+pvalue+"\"><i>"+pvalue+"</i>";
						break;
					}
					case "text": {
						ret+="<input type='text' style='width:100%' id='attr-"+metamodel[i].id+"' value=\""+(value?value:"")+"\">";
						break;
					}
					case "combo": {
						ret+="<select id='attr-"+metamodel[i].id+"'>";
						for (var x=0;x<metamodel[i].items.length;x++)
							ret+="<option value=\""+metamodel[i].items[x].id+"\" "+(value==metamodel[i].items[x].id?"selected":"")+">"+metamodel[i].items[x].id+": "+metamodel[i].items[x].label+"</option>";
						ret+="</select>";
						break;
					}
				}
				ret+="<br><br>";
			}
			return ret;
		}
		
		function getmetadataform(metamodel) {
			var ret={};
			for (var i=0;i<metamodel.length;i++)  {
				switch (metamodel[i].type) {
					case "constant":
					case "text": { ret[metamodel[i].id]=document.getElementById("attr-"+metamodel[i].id).value; break }
					case "combo": { ret[metamodel[i].id]=getcombovalue("attr-"+metamodel[i].id); break}
				}
				if (metamodel[i].value=="number") ret[metamodel[i].id]=ret[metamodel[i].id]*1;
			}
			return ret;
		}
		
		function scrollobjects(fromgroup,gx,gy,cycle) {
			for (var i in data.data.objects) {
				if (!fromgroup||(i==fromgroup)) {
					for (var x=0;x<data.data.objects[i].items.length;x++) {
						data.data.objects[i].items[x].x+=gx;
						data.data.objects[i].items[x].y+=gy;
						if (cycle) {
							if (data.data.objects[i].items[x].y<0) data.data.objects[i].items[x].y=(data.height*templates[data.selectedtemplate].tileheight)+data.data.objects[i].items[x].y;
							if (data.data.objects[i].items[x].x<0) data.data.objects[i].items[x].x=(data.width*templates[data.selectedtemplate].tilewidth)+data.data.objects[i].items[x].x;
							if (data.data.objects[i].items[x].y>=(data.height*templates[data.selectedtemplate].tileheight)) data.data.objects[i].items[x].y=data.data.objects[i].items[x].y-(data.height*templates[data.selectedtemplate].tileheight);
							if (data.data.objects[i].items[x].x>=(data.width*templates[data.selectedtemplate].tilewidth)) data.data.objects[i].items[x].x=data.data.objects[i].items[x].x-(data.width*templates[data.selectedtemplate].tilewidth);
						} else {
							if (data.data.objects[i].items[x].y<0) data.data.objects[i].items[x].y=0;
							if (data.data.objects[i].items[x].x<0) data.data.objects[i].items[x].x=0;
							if (data.data.objects[i].items[x].y>=(data.height*templates[data.selectedtemplate].tileheight)) data.data.objects[i].items[x].y=(data.height*templates[data.selectedtemplate].tileheight);
							if (data.data.objects[i].items[x].x>=(data.width*templates[data.selectedtemplate].tilewidth)) data.data.objects[i].items[x].x=(data.width*templates[data.selectedtemplate].tilewidth);						
						}
					}
				}
			}
		}
		
		function tool(id) {
			switch(id) {
				case "gridwideright": {
					if (!templates[data.selectedtemplate].maxmapsize||(data.width<templates[data.selectedtemplate].maxmapsize.width)) {
						data.width++;
						makegrid();
					} else alert("Cannot change the size of the map. Maximum width is "+templates[data.selectedtemplate].maxmapsize.width+" tile(s).");
					break;
				}
				case "gridwidebottom": {
					if (!templates[data.selectedtemplate].maxmapsize||(data.height<templates[data.selectedtemplate].maxmapsize.height)) {
						data.height++;
						makegrid();
					} else alert("Cannot change the size of the map. Maximum height is "+templates[data.selectedtemplate].maxmapsize.height+" tile(s).");
					break;
				}
				case "gridwidetop": {
					if (!templates[data.selectedtemplate].maxmapsize||(data.height<templates[data.selectedtemplate].maxmapsize.height)) {
						for (var l=0;l<data.data.layers.length;l++) {
							for (var y=data.height-1;y>=0;y--)
								data.data.layers[l].map[y+1]=data.data.layers[l].map[y];
							data.data.layers[l].map[0]=[];
						}
						data.height++;
						scrollobjects(null,0,templates[data.selectedtemplate].tileheight,false);
						makegrid();
					} else alert("Cannot change the size of the map. Maximum height is "+templates[data.selectedtemplate].maxmapsize.height+" tile(s).");
					break;
				}
				case "gridwideleft": {
					if (!templates[data.selectedtemplate].maxmapsize||(data.width<templates[data.selectedtemplate].maxmapsize.width)) {
						for (var l=0;l<data.data.layers.length;l++) {
							for (var y=0;y<data.height;y++) 
								if (data.data.layers[l].map[y]) {
									for (var x=data.width-1;x>=0;x--)
										data.data.layers[l].map[y][x+1]=data.data.layers[l].map[y][x];
									data.data.layers[l].map[y][0]=null;
								}
						}
						data.width++;
						scrollobjects(null,templates[data.selectedtemplate].tilewidth,0,false);						
						makegrid();
					} else alert("Cannot change the size of the map. Maximum width is "+templates[data.selectedtemplate].maxmapsize.width+" tile(s).");
					break;
				}
				case "removebottom": {
					if (data.height>templates[data.selectedtemplate].minmapsize.height) {				
						for (var l=0;l<data.data.layers.length;l++)
							delete data.data.layers[l].map[data.height-1];
						data.height--;
						scrollobjects(null,0,0,false);						
						makegrid();
					} else alert("Cannot change the size of the map. Minimum height is "+templates[data.selectedtemplate].minmapsize.height+" tile(s).");
					break;
				}
				case "removeright": {
					if (data.width>templates[data.selectedtemplate].minmapsize.width) {				
						for (var l=0;l<data.data.layers.length;l++)
							for (var y=0;y<data.height;y++) 
								if (data.data.layers[l].map[y]) delete data.data.layers[l].map[y][data.width-1];
						data.width--;
						scrollobjects(null,0,0,false);
						makegrid();
					} else alert("Cannot change the size of the map. Minimum width is "+templates[data.selectedtemplate].minmapsize.width+" tile(s).");
					break;
				}
				case "removetop": {
					if (data.height>templates[data.selectedtemplate].minmapsize.height) {				
						for (var l=0;l<data.data.layers.length;l++) {
							for (var y=0;y<data.height;y++)
								data.data.layers[l].map[y]=data.data.layers[l].map[y+1];
							delete data.data.layers[l].map[data.height-1];
						}
						data.height--;
						scrollobjects(null,0,-templates[data.selectedtemplate].tileheight,0,false);												
						makegrid();
					} else alert("Cannot change the size of the map. Minimum height is "+templates[data.selectedtemplate].minmapsize.height+" tile(s).");
					break;
				}
				case "removeleft": {
					if (data.width>templates[data.selectedtemplate].minmapsize.width) {				
						for (var l=0;l<data.data.layers.length;l++) {
							for (var y=0;y<data.height;y++) 
								if (data.data.layers[l].map[y]) {
									for (var x=0;x<data.width;x++)
										data.data.layers[l].map[y][x]=data.data.layers[l].map[y][x+1];
									delete data.data.layers[l].map[y][data.width-1];
								}
						}
						data.width--;
						scrollobjects(null,-templates[data.selectedtemplate].tilewidth,0,false);												
						makegrid();
					} else alert("Cannot change the size of the map. Minimum width is "+templates[data.selectedtemplate].minmapsize.width+" tile(s).");
					break;
				}
				case "scrolltop": {
					for (var l=0;l<data.data.layers.length;l++) {
						var s=data.data.layers[l].map[0];
						for (var y=0;y<data.height;y++)
							data.data.layers[l].map[y]=data.data.layers[l].map[y+1];
						data.data.layers[l].map[data.height-1]=s;
					}
					scrollobjects(null,0,-templates[data.selectedtemplate].tileheight,true);											
					makegrid();
					break;
				}
				case "scrollbottom": {
					for (var l=0;l<data.data.layers.length;l++) {
						var s=data.data.layers[l].map[data.height-1];
						for (var y=data.height-2;y>=0;y--)
							data.data.layers[l].map[y+1]=data.data.layers[l].map[y];
						data.data.layers[l].map[0]=s;
					}
					scrollobjects(null,0,templates[data.selectedtemplate].tileheight,true);											
					makegrid();
					break;
				}
				case "scrollleft": {
					for (var l=0;l<data.data.layers.length;l++) {
						for (var y=0;y<data.height;y++)
							if (data.data.layers[l].map[y]) {
								var s=data.data.layers[l].map[y][0];
								for (var x=0;x<data.width-1;x++)
									data.data.layers[l].map[y][x]=data.data.layers[l].map[y][x+1];
								data.data.layers[l].map[y][data.width-1]=s;
							}
					}
					scrollobjects(null,-templates[data.selectedtemplate].tilewidth,0,true);
					makegrid();
					break;
				}
				case "scrollright": {
					for (var l=0;l<data.data.layers.length;l++) {
						for (var y=0;y<data.height;y++)
							if (data.data.layers[l].map[y]) {
								var s=data.data.layers[l].map[y][data.width-1];
								for (var x=data.width-1;x>=0;x--)
									data.data.layers[l].map[y][x]=data.data.layers[l].map[y][x-1];
								data.data.layers[l].map[y][0]=s;
							}
					}
					scrollobjects(null,templates[data.selectedtemplate].tilewidth,0,true);
					makegrid();
					break;
				}
				case "togglelayer": {
					data.layertool[data.selectedlayer].layerhidden=!data.layertool[data.selectedlayer].layerhidden;
					opt(data.currentopt);
					makegrid();
					break;
				}
				case "layermoveup": {
					if (data.selectedlayer>0) {
						var s={l:data.data.layers[data.selectedlayer],lt:data.layertool[data.selectedlayer]};
						data.data.layers[data.selectedlayer]=data.data.layers[data.selectedlayer-1];
						data.layertool[data.selectedlayer]=data.layertool[data.selectedlayer-1];
						data.data.layers[data.selectedlayer-1]=s.l;
						data.layertool[data.selectedlayer-1]=s.lt;
						data.selectedlayer--;
					}
					opt(data.currentopt);
					makegrid();
					break;					
				}
				case "layermovedown": {
					if (data.selectedlayer<data.data.layers.length-1) {
						var s={l:data.data.layers[data.selectedlayer],lt:data.layertool[data.selectedlayer]};
						data.data.layers[data.selectedlayer]=data.data.layers[data.selectedlayer+1];
						data.layertool[data.selectedlayer]=data.layertool[data.selectedlayer+1];
						data.data.layers[data.selectedlayer+1]=s.l;
						data.layertool[data.selectedlayer+1]=s.lt;
						data.selectedlayer++;
					}
					opt(data.currentopt);
					makegrid();
					break;					
				}
				case "layeradd": {
					var gn=prompt("Choose a name for the layer (leave empty for cancel).","");
					if (gn) {
						data.data.layers.push(makelayer(gn));
						data.layertool.push(makelayertool());
						data.selectedlayer=data.data.layers.length-1;
						opt(data.currentopt);
						makegrid();
					}
					break;
				}
				case "layerrename": {
					var gn=prompt("Choose a new name for the layer '"+data.data.layers[data.selectedlayer].name+"' (leave empty for cancel).","");
					if (gn) {
						data.data.layers[data.selectedlayer].name=gn;
						opt(data.currentopt);
					}
					break;
				}
				case "layerdel": {
					if (data.data.layers.length>1) {
						if (confirm("Are you sure to delete this layer?")) {
							for (var l=data.selectedlayer;l<data.data.layers.length-1;l++) {
								data.data.layers[l]=data.data.layers[l+1];
								data.layertool[l]=data.layertool[l+1];
							}
							data.data.layers.pop();
							data.layertool.pop();
							if (data.selectedlayer) data.selectedlayer--;
							opt(data.currentopt);
							makegrid();
						}
					} else alert("Cannot delete the last layer.");
					break;
				}
				case "layerempty": {
					if (confirm("Are you sure to empty this layer?")) {
						data.data.layers[data.selectedlayer].map=[];
						makegrid();
					}
					break;
				}
				case "addobjectgroup": {
					var gn=prompt("Choose a name for the group (leave empty for cancel).","");
					if (gn) {
						if (data.data.objects[gn])
							alert("This group already exists!");
						else {
							data.data.objects[gn]=makegroup();
							data.selectedobjectgroup=gn;
							opt(data.currentopt);
							makeobjects();			
						}
					}
					break;
				}
				case "deleteobjectgroup": {
					if (confirm("Are you sure to delete the object group '"+data.selectedobjectgroup+"'?")) {
						delete data.data.objects[data.selectedobjectgroup];
						data.selectedobjectgroup=null;
						opt(data.currentopt);
						makeobjects();			
					}
					break;
				}
				case "renamegroup": {
					var gn=prompt("Choose a new name for the group '"+data.selectedobjectgroup+"'. (leave empty for cancel).","");
					if (gn) {
						if (data.data.objects[gn])
							alert("This name already exists. Cannot rename.");
						else {
							data.data.objects[gn]=data.data.objects[data.selectedobjectgroup];
							delete data.data.objects[data.selectedobjectgroup];
							data.selectedobjectgroup=gn;
							opt(data.currentopt);
						}
					}
					break;
				}
				case "filesave": {
					if (data.selectedtemplate) {
						detailshow("Copy this text and save on your resource file:<br><textarea cols=80 rows=20 id='_data'></textarea><br><input type=button onclick='detailhide()' value='OK'></input>");
						document.getElementById("_data").value=simpleserializedata();
					} else alert("Select a template first.");
					break;
				}
				case "fileload": {
					detailshow("Paste here the content of your resource file:<br><textarea cols=80 rows=20 id='_data'></textarea><br><input type=button onclick='loadfromtext()' value='Load'> <input type=button onclick='detailhide()' value='Cancel'></input>");
					break;
				}
				case "filenew": {
					if (data.selectedtemplate) {
						if (confirm("Do you really want to start a new resource file? All your unsaved changes will be lost.")) {
							loaddata(null);
							opt(data.currentopt);
							makegrid();			
						}
					} else alert("Select a template first.");
					break;
				}
				case "editmetadata": {
					detailshow("<b>Resources metadata</b><br><br>"+makemetadataform(templates[data.selectedtemplate].metadata,data.data.metadata)+"<hr><input type=button onclick='stagemetaapply()' value='Apply'> <input type=button onclick='detailhide()' value='Cancel'>");
					break;
				}
				case "editobjectmeta": {
					detailshow("<b>Object '"+templates[data.selectedtemplate].objectset[data.selectedobject].longlabel+"' metadata</b><br><br>"+makemetadataform(templates[data.selectedtemplate].objectset[data.selectedobject].metadata,data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject])+"<hr><input type=button onclick='objectmetaapply()' value='Apply'> <input type=button onclick='detailhide()' value='Cancel'>");
					break;				
				}
				case "editlayermeta": {
					detailshow("<b>Layer '"+data.data.layers[data.selectedlayer].name+"' metadata</b><br><br>"+makemetadataform(templates[data.selectedtemplate].layermetadata,data.data.layers[data.selectedlayer])+"<hr><input type=button onclick='layermetaapply()' value='Apply'> <input type=button onclick='detailhide()' value='Cancel'>");
					break;				
				}
				case "editobjectgroupmetadata": {
					detailshow("<b>Object group '"+data.selectedobjectgroup+"' metadata</b><br><br>"+makemetadataform(templates[data.selectedtemplate].objectgroupmetadata,data.data.objects[data.selectedobjectgroup])+"<hr><input type=button onclick='objectgroupmetaapply()' value='Apply'> <input type=button onclick='detailhide()' value='Cancel'>");
					break;
				}
			}		
		}
		
		function objectgroupmetaapply() {
			var getmeta=getmetadataform(templates[data.selectedtemplate].objectgroupmetadata);
			for (var a in getmeta)
				data.data.objects[data.selectedobjectgroup][a]=getmeta[a];
			opt(data.currentopt);
			detailhide();
		}

		function layermetaapply() {
			var getmeta=getmetadataform(templates[data.selectedtemplate].layermetadata);
			for (var a in getmeta)
				data.data.layers[data.selectedlayer][a]=getmeta[a];
			opt(data.currentopt);
			detailhide();
		}
		
		function stagemetaapply() {
			var getmeta=getmetadataform(templates[data.selectedtemplate].metadata);
			for (var a in getmeta)
				data.data.metadata[a]=getmeta[a];
			opt(data.currentopt);
			detailhide();
		}
		
		function objectmetaapply() {
			var getmeta=getmetadataform(templates[data.selectedtemplate].objectset[data.selectedobject].metadata);
			for (var a in getmeta)
				data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject][a]=getmeta[a];
			opt(data.currentopt);
			detailhide();
		}
		
		function loadfromtext() {
			detailhide()
			loaddata(document.getElementById("_data").value);		
			opt(data.currentopt);
			makegrid();			
		}
		
		function selectlayer(i) {
			data.selectedlayer=i;
			opt(data.currentopt);
		}
		
		function settile(x,y,l,t,force) {
			if (!data.data.layers[l].map[y]) data.data.layers[l].map[y]=[];
			if ((data.data.layers[l].map[y][x]!=t)||force) {
				data.data.layers[l].map[y][x]=t;
				var cel=document.getElementById(makeid(x,y,l));
				if (t==null)
					cel.style.backgroundImage="";				
				else {
					cel.style.backgroundImage="url("+templates[data.selectedtemplate].resourcespath+data.index.tiles[data.data.layers[l].tileset]._img+")";
					cel.style.backgroundPosition=getBgPosition(t,l);
				}
			}
		}
		
		function selecttile(t) {
			var tid="palette-"+(data.layertool[data.selectedlayer].selectedtile==null?"null":data.layertool[data.selectedlayer].selectedtile);
			var sel=document.getElementById(tid);
			if (sel) sel.style.border="1px solid white";
			data.layertool[data.selectedlayer].selectedtile=t;
			var cel=document.getElementById("selectedtile");
			if (cel) {
				if (t==null) {
					cel.style.backgroundPosition="0px 0px";
					cel.style.backgroundImage="url(empty.png)";
				} else {
					cel.style.backgroundImage="url("+templates[data.selectedtemplate].resourcespath+data.index.tiles[data.data.layers[data.selectedlayer].tileset]._img+")";			
					cel.style.backgroundPosition=getBgPosition(t,data.selectedlayer);
				}
			}
			tid="palette-"+(data.layertool[data.selectedlayer].selectedtile==null?"null":data.layertool[data.selectedlayer].selectedtile);
			sel=document.getElementById(tid);
			if (sel) sel.style.border="1px solid red";
		}
		
		function selecttemplate(t) {
			if (t) {
				var go=true;
				if (data.selectedtemplate) go=confirm("Are you sure that you want to switch template? All your changes will be lost.");
				if (go) {
					data.selectedtemplate=t;
					loaddata(null); // Load up an empty file
				}
			}
			opt(data.currentopt);
			makegrid();			
		}
		
		function selectobject(t) {
			data.selectedsingleobject=null;
			data.selectedobject=t;
			opt(data.currentopt);
			makeobjects();						
		}
		
		function selecttileset(o) {
			data.data.layers[data.selectedlayer].tileset=o;
			opt(data.currentopt);
			makegrid();			
		}
		
		function selectobjectgroup(g) {
			data.selectedsingleobject=null;
			data.selectedobjectgroup=g;
			opt(data.currentopt);
			makeobjects();			
		}
		
		function linearserialize(t,skip,skipbrackets) {
			var ret="";
			skip=","+skip+",";
			for (var a in t) 
			if (!skip||(skip.indexOf(","+a+",")==-1)){
				if  (!(t instanceof Array)) ret+=a+":";
				if (typeof t[a] == "string") ret+="\""+t[a]+"\""; else if (t[a]==undefined) ret+="null"; else ret+=t[a];
				ret+=", ";
			}
			ret=ret.substr(0,ret.length-2);
			if (!skipbrackets) if (t instanceof Array) ret="["+ret+"]"; else ret="{"+ret+"}";
			return ret;
		}
		
		function simpleserializedata() {
			var strmeta;
			var ret="{\n";
			ret+="\t_template:\""+data.selectedtemplate+"\",\n";
			if (templates[data.selectedtemplate].includeimages) {
				ret+="\taddImage:[\n";
				for (var i=0;i<templates[data.selectedtemplate].addImage.length;i++)
					ret+="\t\t"+linearserialize(templates[data.selectedtemplate].addImage[i])+",\n";
				ret=ret.substr(0,ret.length-2)+"\n\t],\n";
			}
			if (templates[data.selectedtemplate].includetiles) {
				ret+="\taddTiles:[\n";
				for (var i=0;i<templates[data.selectedtemplate].addTiles.length;i++)
					ret+="\t\t"+linearserialize(templates[data.selectedtemplate].addTiles[i])+",\n";
				ret=ret.substr(0,ret.length-2)+"\n\t],\n";
			}
			ret+="\tsetObject:[\n";
			
			// --- Metadata
			if (data.data.metadata) {
				ret+="\t\t{\n"; 
				ret+="\t\t\tobject:\"mapmeta\",\n";
				ret+="\t\t\tproperty:\""+data.data.metadata.objectname+"\",\n";
				ret+="\t\t\tvalue:"+linearserialize(data.data.metadata,"objectname")+"\n";
				ret+="\t\t},\n";
			}
			
			// --- Objects
			for (var gn in data.data.objects) {
				ret+="\t\t{\n"; 
				ret+="\t\t\tobject:\"mapobjects\",\n";
				ret+="\t\t\tproperty:\""+gn+"\",\n";
				ret+="\t\t\tvalue:{\n";
				strmeta=linearserialize(data.data.objects[gn],"items",true);
				if (strmeta) ret+="\t\t\t\t"+strmeta+",\n";				
				ret+="\t\t\t\titems:[\n";
				if (data.data.objects[gn].items.length) {
					for (var i=0;i<data.data.objects[gn].items.length;i++)
						ret+="\t\t\t\t\t"+linearserialize(data.data.objects[gn].items[i])+",\n"
					ret=ret.substr(0,ret.length-2)+"\n";
				}
				ret+="\t\t\t\t]\n"
				ret+="\t\t\t}\n";
				ret+="\t\t},\n";
			}
			// --- End objects

			// --- Layers
			for (var i=0;i<data.data.layers.length;i++) {
				ret+="\t\t{\n";
				ret+="\t\t\tobject:\"tilemaps\",\n";
				ret+="\t\t\tproperty:\""+data.data.layers[i].name+"\",\n";
				ret+="\t\t\tvalue:"+(templates[data.selectedtemplate].usefinalizetilemap?"help.finalizeTilemap(":"")+"{\n";
				ret+="\t\t\t\ttileset:\""+data.data.layers[i].tileset+"\",\n";
				strmeta=linearserialize(data.data.layers[i],"tileset,map,name",true);
				if (strmeta) ret+="\t\t\t\t"+strmeta+",\n";
				ret+="\t\t\t\tmap:[\n";
				for (var y=0;y<data.height;y++) {
					ret+="\t\t\t\t\t[";
					for (var x=0;x<data.width;x++) {
						if (!data.data.layers[i].map[y]||(data.data.layers[i].map[y][x] == null)) ret+="null,"; else
						ret+=data.data.layers[i].map[y][x]+",";
					}
					ret=ret.substr(0,ret.length-1 )+"],\n";
				}
				ret=ret.substr(0,ret.length-2)+"\n\t\t\t\t]\n\t\t\t}"+(templates[data.selectedtemplate].usefinalizetilemap?")":"")+"\n";
				ret+="\t\t},\n";
			}
			// --- End Layers
			
			// End
			ret=ret.substr(0,ret.length-2)+"\n\t]\n}";
			return ret;
		}
		
		
		function loaddata(toeval) {
			
			var loadok=true;
			if (toeval!=null) {
				var loaded;
				var e="Invalid resources file.";
				try {
					loaded=eval("("+toeval+")");
				} catch (e) { loadok=false; }
				if (loadok&&(!loaded||!loaded.setObject)) {
					loadok=false;
					e="Cannot find the setObject section.";
				} else if (loadok&&(!loaded._template||!templates[loaded._template])) {
					var msg="Cannot find the template '"+loaded._template+"' specified in the resources file. ";
					if (data.selectedtemplate) {
						loaded._template=data.selectedtemplate;
						alert(msg+"Trying to apply the current selected one.");
					} else {
						loadok=false;
						e=msg+"Try to select a template first from the file menu.";
					}
				}
				if (loadok) {
					data.selectedtemplate=loaded._template;

					resetconfig();
					
					for (var i=0;i<loaded.setObject.length;i++) {
						var rd=loaded.setObject[i];
						if (rd.object=="mapmeta") { // Loading an objectset
							data.data.metadata=rd.value;
							data.data.metadata.objectname=rd.property;
						} if (rd.object=="mapobjects") // Loading an objectset
							data.data.objects[rd.property]=rd.value;
						if (rd.object=="tilemaps") {// Loading a layer object
							rd.value.name=rd.property;
							data.data.layers.push(rd.value);
							data.layertool.push(makelayertool());
						}
					}
					
					data.height=data.data.layers[0].map.length;
					data.width=data.data.layers[0].map[0].length;
					if (!data.data.metadata.objectname) data.data.metadata.objectname=templates[data.selectedtemplate]._defaultmetadataname;
				} else
					alert("Cannot load the resource file:\n\n"+e);
					
			} else {
				resetconfig();
				data.width=templates[data.selectedtemplate].minmapsize.width;
				data.height=templates[data.selectedtemplate].minmapsize.height;
				for (var i=0;i<templates[data.selectedtemplate].metadata.length;i++)
					data.data.metadata[templates[data.selectedtemplate].metadata[i].id]=templates[data.selectedtemplate].metadata[i].defaultvalue;
			}
			
			if (loadok) {

				// Reindex resources
				for (var i=0;i<templates[data.selectedtemplate].addImage.length;i++) data.index.images[templates[data.selectedtemplate].addImage[i][0]]=templates[data.selectedtemplate].addImage[i][1];
				for (var i=0;i<templates[data.selectedtemplate].addTiles.length;i++) {
					data.index.tiles[templates[data.selectedtemplate].addTiles[i].id]={};
					for (var a in templates[data.selectedtemplate].addTiles[i])
						data.index.tiles[templates[data.selectedtemplate].addTiles[i].id][a]=templates[data.selectedtemplate].addTiles[i][a];
					data.index.tiles[templates[data.selectedtemplate].addTiles[i].id]._img=data.index.images[templates[data.selectedtemplate].addTiles[i].image];
				}
				// Add an empty layer, if needed
				if (!data.data.layers.length) {
					data.data.layers.push(makelayer(templates[data.selectedtemplate].defaultlayername));
					data.layertool.push(makelayertool());
				}
				var ogc=0;
				for (var i in data.data.objects) {ogc=1; break}
				if (!ogc) data.data.objects[templates[data.selectedtemplate].defaultobjectgroupname]=makegroup();
				
			}
			
			// Go!			
			
		}
		
		
		function objectmodeisbrush() {
			return (data.selectedobject);
		}
		
		function pendown(x,y) {
			switch (data.penmode) {
				case 0: {
					data.penstatus=1;
					settile(x,y,data.selectedlayer,data.layertool[data.selectedlayer].selectedtile);
					break;
				}
				case 1: {
					if (data.selectedobjectgroup&&objectmodeisbrush()) {
						var additem=true;
						if ((templates[data.selectedtemplate].objectset[data.selectedobject].mode=="once")&&data.data.objects[data.selectedobjectgroup]) {
							for (var o=0;o<data.data.objects[data.selectedobjectgroup].items.length;o++)
								if (data.data.objects[data.selectedobjectgroup].items[o].objecttype==data.selectedobject) {
									data.data.objects[data.selectedobjectgroup].items[o].x=x*templates[data.selectedtemplate].tilewidth;
									data.data.objects[data.selectedobjectgroup].items[o].y=y*templates[data.selectedtemplate].tileheight;
									additem=false;
									objectclicked(o);
									break;
								}
						}
						if (additem) {
							if (!data.data.objects[data.selectedobjectgroup]) data.data.objects[data.selectedobjectgroup]=makegroup();
							var newobj={objecttype:data.selectedobject,x:x*templates[data.selectedtemplate].tilewidth,y:y*templates[data.selectedtemplate].tileheight};
							if (templates[data.selectedtemplate].objectset[data.selectedobject].metadata) for (var i=0;i<templates[data.selectedtemplate].objectset[data.selectedobject].metadata.length;i++) newobj[templates[data.selectedtemplate].objectset[data.selectedobject].metadata[i].id]=templates[data.selectedtemplate].objectset[data.selectedobject].metadata[i].defaultvalue;
							data.data.objects[data.selectedobjectgroup].items.push(newobj);
							objectclicked(data.data.objects[data.selectedobjectgroup].items.length-1);
						}
					}
					break;
				}
			}
		}
		
		function objectmousemove(obj) {
			setstatus("Object: ("+data.data.objects[data.selectedobjectgroup].items[obj].objecttype+") Tile: ("+Math.floor(data.data.objects[data.selectedobjectgroup].items[obj].x/templates[data.selectedtemplate].tilewidth)+","+Math.floor(data.data.objects[data.selectedobjectgroup].items[obj].y/templates[data.selectedtemplate].tileheight)+") Pixel: ("+data.data.objects[data.selectedobjectgroup].items[obj].x+","+data.data.objects[data.selectedobjectgroup].items[obj].y+")");
		}
		
		function penmove(x,y) {
			var t=(data.data.layers[data.selectedlayer].map[y]?(data.data.layers[data.selectedlayer].map[y][x]==null?"null":data.data.layers[data.selectedlayer].map[y][x]):"null");
			setstatus("Map: (Layer: "+data.selectedlayer+" IDTile: "+t+") Tile: ("+x+","+y+") Pixel: ("+(x*templates[data.selectedtemplate].tilewidth)+","+(y*templates[data.selectedtemplate].tileheight)+")");
			switch (data.penmode) {
				case 0: {
					if (data.penstatus==1) {
						settile(x,y,data.selectedlayer,data.layertool[data.selectedlayer].selectedtile);
					}
				}
			}
		}
		function penup(x,y) {
			switch (data.penmode) {
				case 0: {
					settile(x,y,data.selectedlayer,data.layertool[data.selectedlayer].selectedtile);
					data.penstatus=null;
					break;
				}
			}
		}
		
		function objectclicked(x) {
			if (!data.selectedobject) {
				deleteObjectAtIndex(x,data.selectedobjectgroup);
			} else {
				data.selectedsingleobject=x;
				data.selectedobject=data.data.objects[data.selectedobjectgroup].items[x].objecttype;
				opt(data.currentopt);
			}
			makeobjects();
		}
		
		function opt(id) {
			detailhide();
			data.currentopt=id;
			if (!data.selectedtemplate&&(id!="file")) {
				document.getElementById('toolbox').innerHTML="<i>Please, select a template on the File menu first.</i>";
				return;
			}
			if (id!="objects") data.selectedsingleobject=null;
			makeobjects(id!="objects");
			data.penmode=(id=="objects"?1:0);
			switch(id) {
				case "grid": {
					document.getElementById('toolbox').innerHTML=
						"Size: "+data.width+" x "+data.height+"<br>"+
						(templates[data.selectedtemplate].maxmapsize?"Max size: "+templates[data.selectedtemplate].maxmapsize.width+" x "+templates[data.selectedtemplate].maxmapsize.height+"<br>":"")+
						"Min size: "+templates[data.selectedtemplate].minmapsize.width+" x "+templates[data.selectedtemplate].minmapsize.height+"<br><br>"+
					makebar([
						{id:"gridwideleft",lbl:"Add &laquo;"},{id:"gridwideright",lbl:"Add &raquo;"},{id:"gridwidetop",lbl:"Add ^"},{id:"gridwidebottom",lbl:"Add v"},
						{},
						{id:"removeleft",lbl:"Del &laquo"},{id:"removeright",lbl:"Del &raquo"},{id:"removetop",lbl:"Del ^"},{id:"removebottom",lbl:"Del v"},
						{},
						{id:"scrollleft",lbl:"Shift &laquo"},{id:"scrollright",lbl:"Shift &raquo"},{id:"scrolltop",lbl:"Shift ^"},{id:"scrollbottom",lbl:"Shift v"},
					]);
					break;
				}
				case "edit": {
					var pal="";
					pal+="Layer: <select id='layer' onchange='selectlayer(this.value*1)'>";
					for (var l=0;l<data.data.layers.length;l++) {
						pal+="<option value=\""+l+"\"";
						if (l==data.selectedlayer) pal+=" selected";
						pal+=">"+l+" "+data.data.layers[l].name;
						if (data.layertool[l].layerhidden) pal+=" (H)";
						pal+="</option>";
					}
					pal+="</select><br>";
					pal+=makebar([{id:"togglelayer",lbl:"Toggle"},{id:"layerrename",lbl:"Rename"},{id:"layermoveup",lbl:"Move up"},{id:"layermovedown",lbl:"Move down"},{id:"layeradd",lbl:"Add new"},{id:"layerempty",lbl:"Empty"},{id:"layerdel",lbl:"Delete"},{}]);
					if (templates[data.selectedtemplate].layermetadata) {
						pal+=makebar([{id:"editlayermeta",lbl:"Edit metadata"}]);
						pal+=makemetadatasummary(templates[data.selectedtemplate].layermetadata,data.data.layers[data.selectedlayer]);
						pal+="<br>";
					}

					pal+="<div id='selectedtile' style='width:"+templates[data.selectedtemplate].tilewidth+";height:"+templates[data.selectedtemplate].tileheight+";border:1px dashed white'></div><br>";
					pal+="Tileset: <select id='seltileset' onchange='selecttileset(this.value)'>";
					for (var o=0;o<templates[data.selectedtemplate].addTiles.length;o++) {
						pal+="<option value=\""+templates[data.selectedtemplate].addTiles[o].id+"\"";
						if (templates[data.selectedtemplate].addTiles[o].id==data.data.layers[data.selectedlayer].tileset) pal+=" selected";
						pal+=">"+templates[data.selectedtemplate].addTiles[o].id+"</option>";
					}
					pal+="</select><br>";

					pal+="<div onclick='selecttile(null)' id='palette-null' style='float:left;width:"+templates[data.selectedtemplate].tilewidth+";height:"+templates[data.selectedtemplate].tileheight+";border:1px solid white;background-image:url(empty.png);'></div><br><br>";
					pal+="<div style='width:100%;height:400px;border:1px solid white;overflow:auto'>";
					for (var t=0;t<400;t++)
						pal+="<div onclick='selecttile("+t+")'  id='palette-"+t+"' style='float:left;width:"+templates[data.selectedtemplate].tilewidth+";height:"+templates[data.selectedtemplate].tileheight+";border:1px solid white;background-image:url("+templates[data.selectedtemplate].resourcespath+data.index.tiles[data.data.layers[data.selectedlayer].tileset]._img+");background-position:"+getBgPosition(t,data.selectedlayer)+"'></div>";
					pal+="</div>";
					document.getElementById('toolbox').innerHTML=pal;
					selecttile(data.layertool[data.selectedlayer].selectedtile);
					break;
				}
				case "objects": {
					var pal="";
					pal+="Group: <select id='selobj' onchange='selectobjectgroup(this.value)'>";
					pal+="<option value='' "+(!data.selectedobjectgroup?"selected":"")+">(Select a group)</option>";
					for (var obj in data.data.objects) {
						pal+="<option value=\""+obj+"\"";
						if (obj==data.selectedobjectgroup) pal+=" selected";
						pal+=">"+obj+"</option>";
					}
					pal+="</select><br>";
					pal+=makebar([{id:"addobjectgroup",lbl:"Add group"}]);
					if (data.selectedobjectgroup) {
						pal+="<br>Move pixels/tiles:<br>";
						pal+="<input type=button onclick='moveobjectgroup(-1,-1)' value=' '><input type=button onclick='moveobjectgroup(0,-1)' value=' '><input type=button onclick='moveobjectgroup(1,-1)' value=' '>&nbsp;&nbsp;<input type=button onclick='moveobjectgroup(-1,-1,true)' value=' '><input type=button onclick='moveobjectgroup(0,-1,true)' value=' '><input type=button onclick='moveobjectgroup(1,-1,true)' value=' '><br>";
						pal+="<input type=button onclick='moveobjectgroup(-1,0)' value=' '><input type=button onclick='moveobjectgroup(0,0)' value=' '><input type=button onclick='moveobjectgroup(1,0)' value=' '>&nbsp;&nbsp;<input type=button onclick='moveobjectgroup(-1,0,true)' value=' '><input type=button onclick='moveobjectgroup(0,0,true)' value=' '><input type=button onclick='moveobjectgroup(1,0,true)' value=' '><br>";
						pal+="<input type=button onclick='moveobjectgroup(-1,1)' value=' '><input type=button onclick='moveobjectgroup(0,1)' value=' '><input type=button onclick='moveobjectgroup(1,1)' value=' '>&nbsp;&nbsp;<input type=button onclick='moveobjectgroup(-1,1,true)' value=' '><input type=button onclick='moveobjectgroup(0,1,true)' value=' '><input type=button onclick='moveobjectgroup(1,1,true)' value=' '><br>";
						pal+="<br>";
						pal+=makebar([{id:"renamegroup",lbl:"Rename group"},{id:"deleteobjectgroup",lbl:"Delete group"}]);
						if (templates[data.selectedtemplate].objectgroupmetadata) {
							pal+="<br>"+makebar([{id:"editobjectgroupmetadata",lbl:"Edit metadata"}]);
							pal+=makemetadatasummary(templates[data.selectedtemplate].objectgroupmetadata,data.data.objects[data.selectedobjectgroup]);						
						}
						pal+="<br><br>Tool:<br>";					
						pal+="<select id='selobj' onchange='selectobject(this.value)'>";
						pal+="<option value='' "+(!data.selectedobject?"selected":"")+">(Delete selected)</option>";
						for (var obj in templates[data.selectedtemplate].objectset) {
							pal+="<option value=\""+obj+"\"";
							if (obj==data.selectedobject) pal+=" selected";
							pal+=">"+templates[data.selectedtemplate].objectset[obj].longlabel;
							if (templates[data.selectedtemplate].objectset[obj].mode=="once") pal+=" (once)";
							pal+="</option>";
						}
						pal+="</select><br>";
						if (data.selectedsingleobject!=null) {
							pal+="<br>Move pixels/tiles:<br>";
							pal+="<input type=button onclick='movesingleobject(-1,-1)' value=' '><input type=button onclick='movesingleobject(0,-1)' value=' '><input type=button onclick='movesingleobject(1,-1)' value=' '>&nbsp;&nbsp;<input type=button onclick='movesingleobject(-1,-1,true)' value=' '><input type=button onclick='movesingleobject(0,-1,true)' value=' '><input type=button onclick='movesingleobject(1,-1,true)' value=' '><br>";
							pal+="<input type=button onclick='movesingleobject(-1,0)' value=' '><input type=button onclick='movesingleobject(0,0)' value=' '><input type=button onclick='movesingleobject(1,0)' value=' '>&nbsp;&nbsp;<input type=button onclick='movesingleobject(-1,0,true)' value=' '><input type=button onclick='movesingleobject(0,0,true)' value=' '><input type=button onclick='movesingleobject(1,0,true)' value=' '><br>";
							pal+="<input type=button onclick='movesingleobject(-1,1)' value=' '><input type=button onclick='movesingleobject(0,1)' value=' '><input type=button onclick='movesingleobject(1,1)' value=' '>&nbsp;&nbsp;<input type=button onclick='movesingleobject(-1,1,true)' value=' '><input type=button onclick='movesingleobject(0,1,true)' value=' '><input type=button onclick='movesingleobject(1,1,true)' value=' '><br>";
							pal+="Px: "+data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x+","+data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y+" | Tl: "+Math.floor(data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x/templates[data.selectedtemplate].tilewidth)+","+Math.floor(data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y/templates[data.selectedtemplate].tileheight)+"<br>";
							pal+="<br>";
							if (templates[data.selectedtemplate].objectset[data.selectedobject].metadata) {
								pal+=makebar([{id:"editobjectmeta",lbl:"Edit metadata"}]);
								pal+=makemetadatasummary(templates[data.selectedtemplate].objectset[data.selectedobject].metadata,data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject]);
							}
						}
					}
					document.getElementById('toolbox').innerHTML=pal;					
					break;
				}
				case "file": {
					var pal="";
					pal+="Use template:<br>";
					pal+="<select id='seltempl' onchange='selecttemplate(this.value)'>";
					pal+="<option value='' "+(!data.selectedtemplate?"selected":"")+">(Select a template)</option>";
					for (var obj in templates) {
						pal+="<option value=\""+obj+"\"";
						if (obj==data.selectedtemplate) pal+=" selected";
						pal+=">"+templates[obj].label;
						pal+="</option>";
					}
					pal+="</select><br>";
					if (data.selectedtemplate) {
						if (templates[data.selectedtemplate].notes) {
							pal+="<br>";
							pal+="<b>Notes:</b><br><i>"+templates[data.selectedtemplate].notes+"</i>";
							pal+="<br>";
						}
						if (templates[data.selectedtemplate].metadata) {
							pal+="<br>"+makebar([{id:"editmetadata",lbl:"Edit metadata"}]);
							pal+=makemetadatasummary(templates[data.selectedtemplate].metadata,data.data.metadata);
						}
					}
					pal+="<br><hr>";
					pal+=makebar([{id:"fileload",lbl:"Load resource file"},{id:"filesave",lbl:"Generate resource file"},{},{id:"filenew",lbl:"New resource file"}]);
					document.getElementById('toolbox').innerHTML=pal;
					break;
				}
				// ---
				// Extras. These tools are not map related and are useful for many purposes
				// ---
				case "extra": {
					var pal="";
					pal+="<i>These tools are not map related and are useful for many purposes. Can include ad-hoc calculators, image generators etc.</i><br><br>";
					for (var i=0;i<extras.length;i++) {
						pal+="<a href='#' onclick='openextra("+i+")'>"+extras[i].label+"</a><br>";					
					}
					document.getElementById('toolbox').innerHTML=pal;
					break;				
				}
			}
		}
		
		function openextra(i) {
			extras[i].action();
		}
		
		function getextra(id) {
			return extras[extrasindex[id]];
		}

		function moveobjectgroup(x,y,grid) {
			scrollobjects(data.selectedobjectgroup,x*(grid?templates[data.selectedtemplate].tilewidth:1),y*(grid?templates[data.selectedtemplate].tileheight:1),false);
			makeobjects();
		}
		
		function movesingleobject(x,y,grid) {
			data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x+=x*(grid?templates[data.selectedtemplate].tilewidth:1);
			data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y+=y*(grid?templates[data.selectedtemplate].tileheight:1);
			if (data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x<0) data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x=0;
			if (data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y<0) data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y=0;
			if (data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x+templates[data.selectedtemplate].objectset[data.selectedobject].width>data.width*templates[data.selectedtemplate].tilewidth) data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].x=(data.width*templates[data.selectedtemplate].tilewidth)-templates[data.selectedtemplate].objectset[data.selectedobject].width;
			if (data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y+templates[data.selectedtemplate].objectset[data.selectedobject].height>data.height*templates[data.selectedtemplate].tileheight) data.data.objects[data.selectedobjectgroup].items[data.selectedsingleobject].y=(data.height*templates[data.selectedtemplate].tileheight)-templates[data.selectedtemplate].objectset[data.selectedobject].height;;
			makeobjects();
			opt(data.currentopt);
		}
		
		function makeobjects(del) {
			try {document.body.removeChild(data.oo);}catch(e){}
			delete data.oo;
			if (data.selectedtemplate&&data.selectedobjectgroup)  {
				if (!del) {
					data.oo=document.createElement('span');
					if (data.data.objects[data.selectedobjectgroup]) {
						for (var i=0;i<data.data.objects[data.selectedobjectgroup].items.length;i++) {
							var o=data.data.objects[data.selectedobjectgroup].items[i];
							var os=templates[data.selectedtemplate].objectset[o.objecttype];
							var cel=document.createElement('div');
							cel.style.width=os.width;
							cel.style.height=os.height;
							cel.style.position="absolute";
							cel.style.left=data.editorleftmargin+o.x;
							cel.style.top=data.editortopmargin+o.y;
							if (i==data.selectedsingleobject)
								cel.style.backgroundColor="#FFFFFF";
							else
								cel.style.backgroundColor=os.color;
							cel.innerHTML=os.shortlabel;
							cel.style.opacity=0.8;
							cel.style.zIndex=1000;
							cel.style.overflow="hidden";
							cel.id=makeid(i,"obj","obj");
							cel.style.fontSize="10px";
							cel.onmousedown=function(e){e.preventDefault();var spl=getid(this.id);objectclicked(spl.x)};
							cel.onmousemove=function(e){var spl=getid(this.id);objectmousemove(spl.x)};
							data.oo.appendChild(cel);
						}
					}
					document.body.appendChild(data.oo);
				}
			}
		}
		
		function makegrid() {
			try {document.body.removeChild(data.mo);}catch(e){}
			delete data.mo;
			if (data.selectedtemplate) {
				data.mo=document.createElement('span');
				
				var bg=document.createElement("div");
				bg.style.width=templates[data.selectedtemplate].tilewidth;
				bg.style.height=templates[data.selectedtemplate].tileheight;
				bg.style.position="absolute";
				bg.style.left=data.editorleftmargin;
				bg.style.top=data.editortopmargin;
				bg.style.zIndex=0;
				bg.style.backgroundImage="url(empty.png)";
				bg.style.width=data.width*templates[data.selectedtemplate].tilewidth;
				bg.style.height=data.height*templates[data.selectedtemplate].tileheight;
				data.mo.appendChild(bg);
				var td=null;
				for (var y=0;y<data.height;y++) {
					for (var x=0;x<data.width;x++) {
						for (var l=0;l<data.data.layers.length;l++) {
							var cel=document.createElement('div');
							cel.onmousedown=function(e){e.preventDefault();var spl=getid(this.id);pendown(spl.x,spl.y)};
							cel.onmousemove=function(e){e.preventDefault();var spl=getid(this.id);penmove(spl.x,spl.y)};
							cel.onmouseup=function(e){e.preventDefault();var spl=getid(this.id);penup(spl.x,spl.y)};
							cel.style.width=templates[data.selectedtemplate].tilewidth;
							cel.style.height=templates[data.selectedtemplate].tileheight;
							cel.style.position="absolute";
							cel.style.left=data.editorleftmargin+(x*templates[data.selectedtemplate].tilewidth);
							cel.style.top=data.editortopmargin+(y*templates[data.selectedtemplate].tileheight);
							cel.id=makeid(x,y,l);
							if (data.data.layers[l].tileset) {
								cel.style.zIndex=100-l;
								if (!data.layertool[l].layerhidden&&data.data.layers[l].map[y]&&(data.data.layers[l].map[y][x]!=null)) {
									var t=data.data.layers[l].map[y][x];
									cel.style.backgroundImage="url("+templates[data.selectedtemplate].resourcespath+data.index.tiles[data.data.layers[l].tileset]._img+")";
									cel.style.backgroundPosition=getBgPosition(t,l);
								} else
									cel.style.backgroundImage="";
							}
							data.mo.appendChild(cel);
						}
					}
				}
				document.body.appendChild(data.mo);
			}
		}
		
		
		function onl() {
			// Index the resource file for faster access
			resetconfig();
			for (var i=0;i<extras.length;i++)
				extrasindex[extras[i].id]=i;
			for (var a in templates) {
				for (var i in templates[a].objectset)
					if (templates[a].objectset[i].defaultobject) {
						templates[a]._defaultobject=i;
						break;
					}
				for (var i=0;i<templates[a].metadata.length;i++)
					if (templates[a].metadata[i].id=="objectname") {
						templates[a]._defaultmetadataname=templates[a].metadata[i].defaultvalue;
						break;
					}
				if (!templates[a].minmapsize) templates[a].minmapsize={width:1,height:1};
				if (templates[a].defaulttemplate)
					data.selectedtemplate=a;
			}
			loaddata(null); // Load up an empty file
			document.getElementById("menu").innerHTML="<b>Akiba-ka "+data.version+"</b> | "+makemenu([{id:"file",lbl:"File"},{id:"grid",lbl:"Grid"},{id:"edit",lbl:"Edit"},{id:"objects",lbl:"Objects"},{id:"extra",lbl:"<i>Extras</i>"}]);
			opt("file");
			makegrid();
		}
		
	</script>
</html>

